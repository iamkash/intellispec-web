module.exports = {
  id: 'lamination-screening',
  name: 'Lamination screening',
  description: 'Screen plate laminations from B-scan or stacked A-scans',
  category: 'UT',
  module: 'ndt',
  icon: 'BorderInnerOutlined',
  tags: ['ut', 'lamination', 'vision'],
  uiDefinition: [
    { id: 'input-card', type: 'section', title: 'Input Parameters', description: 'UT setup, acquisition, thresholds, media, metadata', icon: 'FormOutlined', order: 1, size: 24 },
    { id: 'setup', type: 'group', title: 'UT setup', description: 'Wave mode, velocity, thickness, gain, gates', sectionId: 'input-card', order: 1, size: 24 },
    { id: 'wave_mode', type: 'select', title: 'Wave mode', label: 'Wave mode', sectionId: 'input-card', groupId: 'setup', size: 6, options: [ { label: 'Longitudinal', value: 'longitudinal' }, { label: 'Shear', value: 'shear' } ] },
    { id: 'velocity_ms', type: 'number', title: 'Velocity (m/s)', label: 'Velocity (m/s)', sectionId: 'input-card', groupId: 'setup', size: 6 },
    { id: 'thickness_mm', type: 'number', title: 'Thickness t (mm)', label: 'Thickness t (mm)', sectionId: 'input-card', groupId: 'setup', size: 6 },
    { id: 'gain_db', type: 'number', title: 'Gain (dB)', label: 'Gain (dB)', sectionId: 'input-card', groupId: 'setup', size: 6 },
    { id: 'gate1_start_us', type: 'number', title: 'Gate 1 start (µs)', label: 'Gate 1 start (µs)', sectionId: 'input-card', groupId: 'setup', size: 6 },
    { id: 'gate1_width_us', type: 'number', title: 'Gate 1 width (µs)', label: 'Gate 1 width (µs)', sectionId: 'input-card', groupId: 'setup', size: 6 },
    { id: 'gate2_start_us', type: 'number', title: 'Gate 2 start (µs)', label: 'Gate 2 start (µs)', sectionId: 'input-card', groupId: 'setup', size: 6 },
    { id: 'gate2_width_us', type: 'number', title: 'Gate 2 width (µs)', label: 'Gate 2 width (µs)', sectionId: 'input-card', groupId: 'setup', size: 6 },
    { id: 'range_delay', type: 'text', title: 'Range / delay', label: 'Range / delay', sectionId: 'input-card', groupId: 'setup', size: 6 },
    { id: 'acq', type: 'group', title: 'Acquisition', description: 'Modality and traces', sectionId: 'input-card', order: 2, size: 24, collapsible: true },
    { id: 'modality', type: 'select', title: 'Modality', label: 'Modality', sectionId: 'input-card', groupId: 'acq', size: 6, options: [ { label: 'B-scan', value: 'bscan' }, { label: 'Stacked A-scans', value: 'stacked-a' } ] },
    { id: 'index_positions_mm', type: 'textarea', title: 'Index positions (mm)', label: 'Index positions (mm)', sectionId: 'input-card', groupId: 'acq', size: 12, rows: 3 },
    { id: 'a_scan_peaks_gate1', type: 'textarea', title: 'A-scan peaks in Gate 1 (per index)', label: 'A-scan peaks in Gate 1 (per index)', sectionId: 'input-card', groupId: 'acq', size: 12, rows: 3 },
    { id: 'a_scan_peaks_gate2', type: 'textarea', title: 'A-scan peaks in Gate 2 (per index)', label: 'A-scan peaks in Gate 2 (per index)', sectionId: 'input-card', groupId: 'acq', size: 12, rows: 3 },
    { id: 'bscan_amplitude_image', type: 'image-upload-with-drawing', title: 'B-scan amplitude image (optional)', label: 'B-scan amplitude image (optional)', sectionId: 'input-card', groupId: 'acq', size: 24, props: { accept: 'image/*', multiple: false, clientOnly: true, showThumbnails: true, layout: 'grid' } },
    { id: 'backwall_amplitude_trace', type: 'textarea', title: 'Backwall amplitude trace (%FSH)', label: 'Backwall amplitude trace (%FSH)', sectionId: 'input-card', groupId: 'acq', size: 12, rows: 3 },
    { id: 'encoder_resolution_mm', type: 'number', title: 'Encoder resolution (mm)', label: 'Encoder resolution (mm)', sectionId: 'input-card', groupId: 'acq', size: 12 },
    { id: 'rules', type: 'group', title: 'Thresholds and rules', description: 'Persistence, separation, connectivity', sectionId: 'input-card', order: 3, size: 24, collapsible: true },
    { id: 'min_tof_separation_us', type: 'number', title: 'Min TOF separation (µs)', label: 'Min TOF separation (µs)', sectionId: 'input-card', groupId: 'rules', size: 6 },
    { id: 'min_persistence_indices', type: 'number', title: 'Min persistence (indices)', label: 'Min persistence (indices)', sectionId: 'input-card', groupId: 'rules', size: 6 },
    { id: 'min_length_mm', type: 'number', title: 'Min length (mm)', label: 'Min length (mm)', sectionId: 'input-card', groupId: 'rules', size: 6 },
    { id: 'backwall_loss_threshold_pct', type: 'number', title: 'Backwall loss threshold (%)', label: 'Backwall loss threshold (%)', sectionId: 'input-card', groupId: 'rules', size: 6 },
    { id: 'amplitude_threshold_pct', type: 'number', title: 'Amplitude threshold (%FSH)', label: 'Amplitude threshold (%FSH)', sectionId: 'input-card', groupId: 'rules', size: 6 },
    { id: 'connectivity', type: 'select', title: 'Connectivity (B-scan)', label: 'Connectivity (B-scan)', sectionId: 'input-card', groupId: 'rules', size: 6, options: [ { label: '4', value: '4' }, { label: '8', value: '8' } ] },
    { id: 'smoothing_window', type: 'number', title: 'Smoothing window (samples)', label: 'Smoothing window (samples)', sectionId: 'input-card', groupId: 'rules', size: 6 },
    { id: 'media', type: 'group', title: 'Media (optional)', description: 'B-scan/A-scan images', sectionId: 'input-card', order: 4, size: 24, collapsible: true },
    { id: 'bscan_image', type: 'image-upload-with-drawing', title: 'B-scan image', label: 'B-scan image', sectionId: 'input-card', groupId: 'media', size: 24, props: { accept: 'image/*', multiple: true, clientOnly: true, showThumbnails: true, layout: 'grid' } },
    { id: 'a_scan_snippets', type: 'image-upload-with-drawing', title: 'A-scan snippets (flagged indices)', label: 'A-scan snippets (flagged indices)', sectionId: 'input-card', groupId: 'media', size: 24, props: { accept: 'image/*', multiple: true, clientOnly: true, showThumbnails: true, layout: 'grid' } },
    { id: 'thumbnail_size_px', type: 'number', title: 'Thumbnail size (px)', label: 'Thumbnail size (px)', sectionId: 'input-card', groupId: 'media', size: 12 },
    { id: 'annotation_allowed', type: 'switch', title: 'Annotation allowed', label: 'Annotation allowed', sectionId: 'input-card', groupId: 'media', size: 12 },
    { id: 'metadata', type: 'group', title: 'Metadata', description: 'IDs and procedure', sectionId: 'input-card', order: 5, size: 24, collapsible: true },
    { id: 'operator_id', type: 'text', title: 'Operator ID', label: 'Operator ID', sectionId: 'input-card', groupId: 'metadata', size: 6 },
    { id: 'equipment_id', type: 'text', title: 'Equipment ID', label: 'Equipment ID', sectionId: 'input-card', groupId: 'metadata', size: 6 },
    { id: 'timestamp', type: 'text', title: 'Date/Time', label: 'Date/Time', sectionId: 'input-card', groupId: 'metadata', size: 6 },
    { id: 'location_tag', type: 'text', title: 'Location tag', label: 'Location tag', sectionId: 'input-card', groupId: 'metadata', size: 6 },
    { id: 'procedure_id', type: 'text', title: 'Procedure ID', label: 'Procedure ID', sectionId: 'input-card', groupId: 'metadata', size: 12 }
  ],
  aiPrompt: [
    'You are an NDT UT analyst.',
    '',
    'Task: Screen for plate laminations using either B-scan amplitude or stacked A-scans with index positions. Use images as supporting evidence only; decisions come from numeric arrays when available.',
    '',
    'Prechecks:',
    '- Validate velocity, thickness, gates. If arrays differ in length, truncate to the shortest.',
    '- Denoise traces/B-scan with provided smoothing window if given.',
    '- Ensure Gate 1 captures potential internal echoes; Gate 2 captures backwall.',
    '',
    'Definitions and logic:',
    '- Depth z(mm) = v * TOF(us) / 2000.',
    '- Lamination (stacked A): internal echo in Gate 1 with TOF separation ≥ Min TOF separation, persisting for ≥ Min persistence indices, total length ≥ Min length.',
    '- Lamination (B-scan): near-horizontal band; detect via threshold + connected components; keep components with low depth variance and area above filter.',
    '- Backwall loss% = 100 * (1 - BW / local baseline).',
    '- Classify severity using configured rules on z/t, length, and BW loss.',
    '',
    'Output ONLY:',
    '',
    '# Lamination Screening',
    '',
    '## Report Summary',
    'One concise sentence summarizing lamination count, depth band, BW loss link, and severity.',
    '',
    '## Input Summary',
    '- Mode: <longitudinal/shear>, Velocity: <m/s>, Thickness t: <mm>, Gain: <dB>',
    '- Gates: Gate1 <start–width µs>, Gate2 <start–width µs>, Range/Delay: <...>',
    '- Modality: <B-scan / Stacked A-scans>, Encoder step: <mm>',
    '- Thresholds: Min TOF sep <µs>, Min persistence <samples>, Min length <mm>, BW loss ≥ <percent>, Amp ≥ <percent FSH>',
    '- Media: <types and counts or "None">',
    '- Operator/Equipment/Date/Location: <...>',
    '',
    '## Key Outputs',
    '| Key outputs | Value |',
    '| --- | --- |',
    '| Lamination count | <value> |',
    '| Depth range (mm) | <list per lamination> |',
    '| Depth ratio z/t | <min / mean / max> |',
    '| Length per lamination (mm) | <list> |',
    '| Backwall loss association | <per lamination: Yes/No, max %> |',
    '| Covered length flagged (%) | <value> |',
    '| Severity class | <Low/Moderate/High> |',
    '| Flagged zones | <index ranges or boxes> |',
    '',
    '## Calculations',
    '- Show TOF→depth conversion and first few indices.',
    '- Show persistence check and computed lengths.',
    '- Show BW loss computation and any zones over threshold.',
    '- If B-scan used, summarize component labeling (area, depth variance, orientation).',
    '- Note any gating or SNR warnings.',
    '',
    '## Rationale',
    'One concise sentence on whether indications match planar laminations and what follow-up is needed (e.g., confirm with through-thickness shear or PAUT; consider local grind/repair if severity High).',
    '',
    'END OF REPORT'
  ].join('\n')
};


