module.exports = {
  id: 'paut-sectorial-law-coverage',
  name: 'PAUT Sectorial Law & Coverage',
  description: 'Build PAUT S-scan laws and estimate weld/HAZ coverage with gating and dead-zone constraints',
  category: 'PAUT',
  module: 'ndt',
  icon: 'RadarChartOutlined',
  tags: ['paut', 'sectorial', 'coverage', 'vision'],
  uiDefinition: [
    { id: 'input-card', type: 'section', title: 'Input Parameters', description: 'Probe, wedge, laws, geometry, raster, media, metadata', icon: 'FormOutlined', order: 1, size: 24 },

    // Probe, wedge, and material
    { id: 'probe', type: 'group', title: 'Probe, wedge, and material', description: 'Array, wedge, and material velocities', sectionId: 'input-card', order: 1, size: 24 },
    { id: 'probe_id', type: 'text', title: 'Probe ID', label: 'Probe ID', sectionId: 'input-card', groupId: 'probe', size: 8, placeholder: 'e.g., 5L64-0.6' },
    { id: 'elements_total', type: 'number', title: 'Elements (total)', label: 'Elements (total)', sectionId: 'input-card', groupId: 'probe', size: 4 },
    { id: 'pitch_mm', type: 'number', title: 'Pitch p (mm)', label: 'Pitch p (mm)', sectionId: 'input-card', groupId: 'probe', size: 4 },
    { id: 'center_frequency_mhz', type: 'number', title: 'Center frequency f (MHz)', label: 'Center frequency f (MHz)', sectionId: 'input-card', groupId: 'probe', size: 4 },
    { id: 'wedge_id', type: 'text', title: 'Wedge ID', label: 'Wedge ID', sectionId: 'input-card', groupId: 'probe', size: 6 },
    { id: 'wedge_angle_deg', type: 'number', title: 'Wedge angle ψ (°)', label: 'Wedge angle ψ (°)', sectionId: 'input-card', groupId: 'probe', size: 6 },
    { id: 'wedge_velocity_ms', type: 'number', title: 'Wedge velocity v_w (m/s)', label: 'Wedge velocity v_w (m/s)', sectionId: 'input-card', groupId: 'probe', size: 6 },
    { id: 'index_offset_mm', type: 'number', title: 'Index offset (mm)', label: 'Index offset (mm)', sectionId: 'input-card', groupId: 'probe', size: 6 },
    { id: 'material_mode', type: 'select', title: 'Material mode', label: 'Material mode', sectionId: 'input-card', groupId: 'probe', size: 6, options: [ { label: 'Shear', value: 'shear' }, { label: 'Longitudinal', value: 'longitudinal' } ] },
    { id: 'material_velocity_ms', type: 'number', title: 'Material velocity v_m (m/s)', label: 'Material velocity v_m (m/s)', sectionId: 'input-card', groupId: 'probe', size: 6 },

    // Sectorial scan plan (laws)
    { id: 'laws', type: 'group', title: 'Sectorial scan plan (laws)', description: 'Angles, aperture, focus, apodization', sectionId: 'input-card', order: 2, size: 24, collapsible: true },
    { id: 'theta_min_deg', type: 'number', title: 'Refracted angle θ_min (°)', label: 'Refracted angle θ_min (°)', sectionId: 'input-card', groupId: 'laws', size: 6 },
    { id: 'theta_max_deg', type: 'number', title: 'Refracted angle θ_max (°)', label: 'Refracted angle θ_max (°)', sectionId: 'input-card', groupId: 'laws', size: 6 },
    { id: 'angle_step_deg', type: 'number', title: 'Angle step Δθ (°)', label: 'Angle step Δθ (°)', sectionId: 'input-card', groupId: 'laws', size: 6 },
    { id: 'active_aperture_elements', type: 'number', title: 'Active aperture (elements)', label: 'Active aperture (elements)', sectionId: 'input-card', groupId: 'laws', size: 6 },
    { id: 'focal_depth_mm', type: 'text', title: 'Focal depth z_f (mm)', label: 'Focal depth z_f (mm)', sectionId: 'input-card', groupId: 'laws', size: 6, placeholder: 'single value, list, or ∞' },
    { id: 'apodization', type: 'select', title: 'Apodization', label: 'Apodization', sectionId: 'input-card', groupId: 'laws', size: 6, options: [ { label: 'None', value: 'none' }, { label: 'Hann', value: 'hann' }, { label: 'Hamming', value: 'hamming' } ] },
    { id: 'tcg_dac_target_pct', type: 'number', title: 'TCG/DAC target (%FSH)', label: 'TCG/DAC target (%FSH)', sectionId: 'input-card', groupId: 'laws', size: 6 },
    { id: 'max_steering_wedge_deg', type: 'number', title: 'Max steering in wedge (°)', label: 'Max steering in wedge (°)', sectionId: 'input-card', groupId: 'laws', size: 6 },

    // Geometry & coverage
    { id: 'geometry', type: 'group', title: 'Geometry & coverage', description: 'Weld polygon and depth window', sectionId: 'input-card', order: 3, size: 24, collapsible: true },
    { id: 'thickness_mm', type: 'number', title: 'Thickness t (mm)', label: 'Thickness t (mm)', sectionId: 'input-card', groupId: 'geometry', size: 6 },
    { id: 'weld_type', type: 'select', title: 'Weld type', label: 'Weld type', sectionId: 'input-card', groupId: 'geometry', size: 6, options: [ { label: 'Single-V', value: 'single-v' }, { label: 'Double-V', value: 'double-v' }, { label: 'Fillet', value: 'fillet' } ] },
    { id: 'weld_dims', type: 'text', title: 'Weld dimensions / polygon', label: 'Weld dimensions / polygon', sectionId: 'input-card', groupId: 'geometry', size: 12, placeholder: 'cap/root widths, bevels or polygon JSON' },
    { id: 'haz_band_mm', type: 'number', title: 'HAZ band (mm)', label: 'HAZ band (mm)', sectionId: 'input-card', groupId: 'geometry', size: 6 },
    { id: 'z_dead_mm', type: 'number', title: 'Near-surface dead depth z_dead (mm)', label: 'Near-surface dead depth z_dead (mm)', sectionId: 'input-card', groupId: 'geometry', size: 6 },
    { id: 'gate_depth_min_mm', type: 'number', title: 'Gate depth min (mm)', label: 'Gate depth min (mm)', sectionId: 'input-card', groupId: 'geometry', size: 6 },
    { id: 'gate_depth_max_mm', type: 'number', title: 'Gate depth max (mm)', label: 'Gate depth max (mm)', sectionId: 'input-card', groupId: 'geometry', size: 6 },
    { id: 'max_skips', type: 'number', title: 'Max skips', label: 'Max skips', sectionId: 'input-card', groupId: 'geometry', size: 6 },

    // Raster / deployment
    { id: 'raster', type: 'group', title: 'Raster / deployment', description: 'Sides, rows, spans, length pitch', sectionId: 'input-card', order: 4, size: 24, collapsible: true },
    { id: 'scan_sides', type: 'select', title: 'Scan side(s)', label: 'Scan side(s)', sectionId: 'input-card', groupId: 'raster', size: 6, options: [ { label: 'Near', value: 'near' }, { label: 'Far', value: 'far' }, { label: 'Both', value: 'both' } ] },
    { id: 'row_pitch_mm', type: 'number', title: 'Row pitch p_r (mm)', label: 'Row pitch p_r (mm)', sectionId: 'input-card', groupId: 'raster', size: 6 },
    { id: 'row_span_mm', type: 'number', title: 'Row span (mm)', label: 'Row span (mm)', sectionId: 'input-card', groupId: 'raster', size: 6 },
    { id: 'along_length_pitch_mm', type: 'number', title: 'Along-length pitch (mm)', label: 'Along-length pitch (mm)', sectionId: 'input-card', groupId: 'raster', size: 6 },

    // Media & metadata
    { id: 'media', type: 'group', title: 'Media & metadata (optional)', description: 'Overlay and IDs', sectionId: 'input-card', order: 5, size: 24, collapsible: true },
    { id: 'overlay_image', type: 'image-upload-with-drawing', title: 'Cross-section overlay', label: 'Cross-section overlay', sectionId: 'input-card', groupId: 'media', size: 24, props: { accept: 'image/*', multiple: true, clientOnly: true, showThumbnails: true, layout: 'grid' } },
    { id: 'operator_id', type: 'text', title: 'Operator ID', label: 'Operator ID', sectionId: 'input-card', groupId: 'media', size: 6 },
    { id: 'equipment_id', type: 'text', title: 'Equipment ID', label: 'Equipment ID', sectionId: 'input-card', groupId: 'media', size: 6 },
    { id: 'timestamp', type: 'text', title: 'Date/Time', label: 'Date/Time', sectionId: 'input-card', groupId: 'media', size: 6 },
    { id: 'location_tag', type: 'text', title: 'Location', label: 'Location', sectionId: 'input-card', groupId: 'media', size: 6 }
  ],
  aiPrompt: [
    'You are an NDT UT analyst.',
    '',
    'Task: Generate a PAUT sectorial (S-scan) focal law set and estimate weld/HAZ coverage for the chosen angles and raster plan. Apply Snell mapping, grating-lobe limits, and basic beam metrics. Use images only as overlays; do not digitize.',
    '',
    'Prechecks:',
    '- Validate probe (elements, pitch, frequency), wedge (angle, velocity), material velocity/mode, angle range, aperture, focus depth, and raster plan.',
    '- Convert degrees→radians internally. Compute λ_w, λ_m. If any field missing, mark affected outputs "Unknown" and proceed.',
    '',
    'Definitions and logic:',
    '- Snell: sinφ = (v_w/v_m)·sinθ. Reject θ if |sinφ|>1.',
    '- Grating-lobe limit (wedge): |sinφ| ≤ λ_w/p (use 0.9 margin if no apodization). Flag violations.',
    '- Delay law: τ_i = L_w,i/v_w + L_m,i/v_m; Δτ_i = τ_i − min(τ).',
    '- Beam metrics: a=(N_act·p)/2; z_R≈a²/λ_m; F#=z_f/(2a); β≈2·arcsin(0.61·λ_m/a); ρ(z)=z·tan(β/2).',
    '- Valid depth window: z ∈ [max(z_dead, gate_min), gate_max].',
    '- Coverage: discretize weld+HAZ; a cell is covered if reachable by any law and transverse row fill C_perp(z)=min(1, 2ρ/p_r) > 0.',
    '',
    'Output ONLY:',
    '',
    '# PAUT Sectorial Law Set & Coverage Advisor',
    '',
    '## Report Summary',
    'One concise sentence summarizing angle pack, any grating-lobe violations, and coverage headline.',
    '',
    '## Input Summary',
    '- Probe: <ID, f MHz, elements, pitch p mm>; Wedge: <ID, ψ°, v_w m/s, index offset>',
    '- Material: <mode, v_m m/s>, Thickness t: <mm>, Weld: <type + dims>, HAZ band: <mm>',
    '- S-scan: θ_min–θ_max <°>, step <°>, Active aperture <els>, Focus z_f <mm or ∞>, Apodization <type>',
    '- Gates: depth <min–max mm>, z_dead <mm>, Max skips ≤ <n>',
    '- Raster: sides <near/far/both>, row pitch p_r <mm>, row span <mm>, along-length pitch <mm>',
    '',
    '## Key Outputs',
    '| Key outputs | Value |',
    '| --- | --- |',
    '| Angle set (θ) | <list/range> |',
    '| Grating-lobe margin | <min margin or "Violation at θ=..."> |',
    '| F# / z_R flags | <per angle: OK / Caution> |',
    '| Law pack summary | <count, first–last, step> |',
    '| TCG equalization span (dB) | <value or Unknown> |',
    '| Weld coverage (%) | <value> |',
    '| HAZ coverage (%) | <value> |',
    '| Depth band coverage (%) | <0–0.2t: x, 0.2–0.5t: y, >0.5t: z> |',
    '| Uncovered regions | <text or polygons> |',
    '| Recommended adjustments | <bullets> |',
    '',
    '## Calculations',
    '- Snell mapping φ(θ); show limits and any rejected angles.',
    '- Grating-lobe check: compare |sinφ| vs λ_w/p (and margin).',
    '- Beam metrics for a representative angle (β, ρ(z) at 0.1t/0.3t/0.6t); C_perp(z) vs depth.',
    '- Coverage union across angles, noting zones clipped by z_dead/gate.',
    '',
    '## Rationale',
    'One sentence on whether the pack gives adequate fusion/HAZ coverage and minimal changes to reach ≥90–95% where needed.',
    '',
    'END OF REPORT'
  ].join('\n')
};



