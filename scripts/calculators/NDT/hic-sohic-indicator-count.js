module.exports = {
  id: 'hic-sohic-indicator-count',
  name: 'HIC and SOHIC indicator count',
  description: 'Detect blisters and stepwise cracking patterns from C-scan',
  category: 'UT',
  module: 'ndt',
  icon: 'AppstoreAddOutlined',
  tags: ['ut', 'hic', 'sohic', 'vision'],
  uiDefinition: [
    { id: 'input-card', type: 'section', title: 'Input Parameters', description: 'Acquisition, C-scan data, thresholds, media, metadata', icon: 'FormOutlined', order: 1, size: 24 },
    { id: 'acq', type: 'group', title: 'Acquisition and geometry', description: 'Component and scan setup', sectionId: 'input-card', order: 1, size: 24 },
    { id: 'component_id', type: 'text', title: 'Component ID', label: 'Component ID', sectionId: 'input-card', groupId: 'acq', size: 6 },
    { id: 'material', type: 'text', title: 'Material', label: 'Material', sectionId: 'input-card', groupId: 'acq', size: 6, placeholder: 'plate, vessel shell, line pipe' },
    { id: 'thickness_mm', type: 'number', title: 'Thickness (mm)', label: 'Thickness (mm)', sectionId: 'input-card', groupId: 'acq', size: 6 },
    { id: 'scan_area_mm', type: 'text', title: 'Scan area (mm × mm)', label: 'Scan area (mm × mm)', sectionId: 'input-card', groupId: 'acq', size: 6 },
    { id: 'pixel_size_mm', type: 'text', title: 'Pixel size (mm)', label: 'Pixel size (mm)', sectionId: 'input-card', groupId: 'acq', size: 6, placeholder: 'px_x × px_y' },
    { id: 'calibration_notes', type: 'text', title: 'Calibration', label: 'Calibration', sectionId: 'input-card', groupId: 'acq', size: 6, placeholder: 'velocity, wedge delay, zero check' },
    { id: 'cscan', type: 'group', title: 'C-scan data', description: 'Amplitude/TOF/backwall maps', sectionId: 'input-card', order: 2, size: 24, collapsible: true },
    { id: 'amplitude_map', type: 'textarea', title: 'Amplitude map (%FSH or dB) 2D array', label: 'Amplitude map (%FSH or dB) 2D array', sectionId: 'input-card', groupId: 'cscan', size: 24, rows: 4 },
    { id: 'tof_map', type: 'textarea', title: 'TOF map (µs or mm) 2D array', label: 'TOF map (µs or mm) 2D array', sectionId: 'input-card', groupId: 'cscan', size: 24, rows: 4 },
    { id: 'backwall_map', type: 'textarea', title: 'Backwall map (%FSH) 2D array (optional)', label: 'Backwall map (%FSH) 2D array (optional)', sectionId: 'input-card', groupId: 'cscan', size: 24, rows: 3 },
    { id: 'invalid_mask', type: 'textarea', title: 'Mask of invalid cells (optional)', label: 'Mask of invalid cells (optional)', sectionId: 'input-card', groupId: 'cscan', size: 24, rows: 3 },
    { id: 'thresholds', type: 'group', title: 'Detection thresholds and rules', description: 'HIC/SOHIC logic', sectionId: 'input-card', order: 3, size: 24, collapsible: true },
    { id: 'blister_tof_rise_threshold', type: 'text', title: 'Blister TOF rise threshold (mm or µs)', label: 'Blister TOF rise threshold (mm or µs)', sectionId: 'input-card', groupId: 'thresholds', size: 12 },
    { id: 'backwall_loss_threshold_pct', type: 'number', title: 'Backwall loss threshold (%FSH)', label: 'Backwall loss threshold (%FSH)', sectionId: 'input-card', groupId: 'thresholds', size: 12 },
    { id: 'min_blister_area_mm2', type: 'number', title: 'Min blister area (mm²)', label: 'Min blister area (mm²)', sectionId: 'input-card', groupId: 'thresholds', size: 12 },
    { id: 'sohic_angle_bands', type: 'text', title: 'SOHIC angle bands (°)', label: 'SOHIC angle bands (°)', sectionId: 'input-card', groupId: 'thresholds', size: 12, placeholder: 'e.g., 0±15, 90±15' },
    { id: 'min_crack_length_mm', type: 'number', title: 'Min crack length (mm)', label: 'Min crack length (mm)', sectionId: 'input-card', groupId: 'thresholds', size: 12 },
    { id: 'bridge_gap_limit_mm', type: 'number', title: 'Bridge gap limit (mm)', label: 'Bridge gap limit (mm)', sectionId: 'input-card', groupId: 'thresholds', size: 12 },
    { id: 'connectivity', type: 'select', title: 'Connectivity', label: 'Connectivity', sectionId: 'input-card', groupId: 'thresholds', size: 12, options: [ { label: '4', value: '4' }, { label: '8', value: '8' } ] },
    { id: 'smoothing_window_px', type: 'number', title: 'Smoothing window (pixels)', label: 'Smoothing window (pixels)', sectionId: 'input-card', groupId: 'thresholds', size: 12 },
    { id: 'morphology_choice', type: 'text', title: 'Morphology choice', label: 'Morphology choice', sectionId: 'input-card', groupId: 'thresholds', size: 12, placeholder: 'opening/closing kernel' },
    { id: 'media', type: 'group', title: 'Media input (optional)', description: 'C-scan images and B-scans', sectionId: 'input-card', order: 4, size: 24, collapsible: true },
    { id: 'cscan_amplitude_image', type: 'image-upload-with-drawing', title: 'C-scan amplitude image', label: 'C-scan amplitude image', sectionId: 'input-card', groupId: 'media', size: 24, props: { accept: 'image/*', multiple: true, clientOnly: true, showThumbnails: true, layout: 'grid' } },
    { id: 'cscan_tof_image', type: 'image-upload-with-drawing', title: 'C-scan TOF image', label: 'C-scan TOF image', sectionId: 'input-card', groupId: 'media', size: 24, props: { accept: 'image/*', multiple: true, clientOnly: true, showThumbnails: true, layout: 'grid' } },
    { id: 'bscan_snippets', type: 'image-upload-with-drawing', title: 'B-scan snippets (optional)', label: 'B-scan snippets (optional)', sectionId: 'input-card', groupId: 'media', size: 24, props: { accept: 'image/*', multiple: true, clientOnly: true, showThumbnails: true, layout: 'grid' } },
    { id: 'thumbnail_size', type: 'number', title: 'Thumbnail size (px)', label: 'Thumbnail size (px)', sectionId: 'input-card', groupId: 'media', size: 12 },
    { id: 'annotation_allowed', type: 'switch', title: 'Annotation allowed', label: 'Annotation allowed', sectionId: 'input-card', groupId: 'media', size: 12 },
    { id: 'metadata', type: 'group', title: 'Metadata', description: 'IDs and procedure', sectionId: 'input-card', order: 5, size: 24, collapsible: true },
    { id: 'operator_id', type: 'text', title: 'Operator ID', label: 'Operator ID', sectionId: 'input-card', groupId: 'metadata', size: 6 },
    { id: 'equipment_id', type: 'text', title: 'Equipment ID', label: 'Equipment ID', sectionId: 'input-card', groupId: 'metadata', size: 6 },
    { id: 'timestamp', type: 'text', title: 'Date/Time', label: 'Date/Time', sectionId: 'input-card', groupId: 'metadata', size: 6 },
    { id: 'location_tag', type: 'text', title: 'Location tag', label: 'Location tag', sectionId: 'input-card', groupId: 'metadata', size: 6 },
    { id: 'procedure_id', type: 'text', title: 'Procedure ID', label: 'Procedure ID', sectionId: 'input-card', groupId: 'metadata', size: 12 }
  ],
  aiPrompt: [
    'You are an NDT UT analyst.',
    '',
    'Task: From C-scan amplitude and TOF data, count HIC blisters and detect SOHIC stepwise cracking sets. Use images for support. Do not digitize from images if numeric arrays are provided.',
    '',
    'Prechecks:',
    '- Validate pixel size and grid sizes for amplitude and TOF maps. If mismatched, crop to common area.',
    '- Apply mask to invalid cells. Denoise with a small median filter if Smoothing window is provided.',
    '',
    'Detection rules:',
    '- Blister: local TOF rise ≥ Blister TOF rise threshold, optional backwall loss below threshold, area ≥ Min blister area, component shape not highly elongated.',
    '- SOHIC: crack-like components whose principal angle lies within specified SOHIC angle bands. Chain segments into a set if gaps ≤ Bridge gap limit and angle difference ≤ 15°. Keep sets with total length ≥ Min crack length.',
    '',
    'Outputs:',
    '- Counts, areas, lengths, orientation histogram, flagged zones, and severity class per configured bands.',
    '',
    'Output ONLY:',
    '',
    '# HIC and SOHIC Indicator Count',
    '',
    '## Report Summary',
    'One concise sentence summarizing blister/SOHIC counts, severity, and flagged zones.',
    '',
    '## Input Summary',
    '- Component: <id>, Material: <material>, Location: <tag>, Thickness: <mm>',
    '- Scan area: <mm × mm>, Pixel size: <px_x mm × px_y mm>',
    '- Thresholds: ΔTOF ≥ <value>, Backwall loss < <percent FSH or None>, Min blister area <mm²>, SOHIC angles <bands>, Min crack length <mm>, Bridge gap ≤ <mm>, Connectivity <4/8>, Smoothing <window or None>',
    '- Media: <types and counts or None>',
    '- Operator/Equipment/Date: <ids and timestamp>',
    '',
    '## Key Outputs',
    '| Key outputs | Value |',
    '| --- | --- |',
    '| Blister count | <value> |',
    '| Total blister area (mm²) | <value> |',
    '| Largest blister diameter (mm) | <value> |',
    '| SOHIC set count | <value> |',
    '| Total SOHIC length (mm) | <value> |',
    '| Orientation histogram | <e.g., 0°: n, 90°: n, other: n> |',
    '| Flagged zones | <list of boxes or None> |',
    '| Severity class | <Low or Moderate or High> |',
    '',
    '## Calculations',
    '- TOF rise logic and threshold used.',
    '- Connected component stats for blisters: area, equivalent diameter.',
    '- Skeleton lengths and chaining for SOHIC sets, with gap and angle criteria.',
    '- Any assumptions, smoothing, or morphology applied.',
    '',
    '## Rationale',
    'One concise sentence on whether the pattern looks like isolated blisters, stepwise cracking, or mixed, and what to do next.',
    '',
    'END OF REPORT'
  ].join('\n')
};


