module.exports = {
  id: 'corrosion-map-stats',
  name: 'Corrosion map stats',
  description: 'Summarize a UT thickness map and flag thin zones vs Tmin and CA',
  category: 'UT',
  module: 'ndt',
  icon: 'HeatMapOutlined',
  tags: ['ut', 'c-scan', 'map', 'vision'],
  uiDefinition: [
    { id: 'input-card', type: 'section', title: 'Input Parameters', description: 'Geometry, thresholds, and grid', icon: 'FormOutlined', order: 1, size: 24 },
    { id: 'geom', type: 'group', title: 'Geometry & Context', description: 'Component and grid layout', sectionId: 'input-card', order: 1, size: 24 },
    { id: 'component_id', type: 'text', title: 'Component ID', label: 'Component ID', sectionId: 'input-card', groupId: 'geom', size: 8 },
    { id: 't_nom_mm', type: 'number', title: 'Nominal thickness t_nom (mm)', label: 'Nominal thickness t_nom (mm)', sectionId: 'input-card', groupId: 'geom', size: 8 },
    { id: 'tmin_mm', type: 'number', title: 'Minimum allowable thickness Tmin (mm)', label: 'Minimum allowable thickness Tmin (mm)', sectionId: 'input-card', groupId: 'geom', size: 8 },
    { id: 'ca_mm', type: 'number', title: 'Corrosion allowance CA (mm)', label: 'Corrosion allowance CA (mm)', sectionId: 'input-card', groupId: 'geom', size: 8 },
    { id: 'grid_pitch_mm', type: 'number', title: 'Measurement spacing (mm)', label: 'Measurement spacing (mm)', sectionId: 'input-card', groupId: 'geom', size: 8 },
    { id: 'location_ref', type: 'text', title: 'Location reference', label: 'Location reference', sectionId: 'input-card', groupId: 'geom', size: 8, placeholder: 'e.g., circumferential × longitudinal' },
    { id: 'thresholds', type: 'group', title: 'Thresholds', description: 'Thin cell and cluster rules', sectionId: 'input-card', order: 2, size: 24, collapsible: true },
    { id: 'thin_zone_criterion', type: 'text', title: 'Thin zone criterion (% or mm)', label: 'Thin zone criterion (% or mm)', sectionId: 'input-card', groupId: 'thresholds', size: 12, placeholder: 'e.g., < Tmin or < Tmin + CA' },
    { id: 'cluster_size', type: 'number', title: 'Cluster size (count)', label: 'Cluster size (count)', sectionId: 'input-card', groupId: 'thresholds', size: 12 },
    { id: 'grid', type: 'group', title: 'Thickness grid (matrix)', description: '2D UT thickness values', sectionId: 'input-card', order: 3, size: 24, collapsible: true },
    { id: 'thickness_grid', type: 'textarea', title: 'Grid data (JSON 2D array)', label: 'Grid data (JSON 2D array)', sectionId: 'input-card', groupId: 'grid', size: 24, rows: 6, placeholder: 'e.g., [[10.1,9.8],[9.6,9.4]]' },
    { id: 'media', type: 'group', title: 'Media Input (Optional)', description: 'C-scan/B-scan image or thickness color map', sectionId: 'input-card', order: 4, size: 24, collapsible: true },
    { id: 'map_image', type: 'image-upload-with-drawing', title: 'Map Image', label: 'Map Image', sectionId: 'input-card', groupId: 'media', size: 24, props: { accept: 'image/*', multiple: false, clientOnly: true, showThumbnails: true, layout: 'grid' } },
    { id: 'metadata', type: 'group', title: 'Metadata', description: 'QA traceability', sectionId: 'input-card', order: 5, size: 24, collapsible: true },
    { id: 'operator_id', type: 'text', title: 'Operator ID', label: 'Operator ID', sectionId: 'input-card', groupId: 'metadata', size: 8 },
    { id: 'equipment_id', type: 'text', title: 'Equipment ID', label: 'Equipment ID', sectionId: 'input-card', groupId: 'metadata', size: 8 },
    { id: 'timestamp', type: 'text', title: 'Date/Time', label: 'Date/Time', sectionId: 'input-card', groupId: 'metadata', size: 8 }
  ],
  aiPrompt: [
    'You are an NDT UT analyst.',
    '',
    'Task: Summarize a corrosion UT thickness map and flag thin zones versus Tmin and CA.',
    'Handle both numeric grid data and optional uploaded images.',
    '',
    'Prechecks:',
    '- If grid data is missing or non-numeric, return "Unknown".',
    '- If t_nom, Tmin, or CA are missing, flag as "Unknown" where applicable.',
    '- If an image is provided (C-scan, B-scan, or thickness color map):',
    '  - Use it only as supplementary context (do not try to digitize values).',
    '  - Mention it in the report under "Media Input".',
    '- Handle grids of any size; show only key stats in the report, not the full grid.',
    '',
    'Definitions:',
    '- Mean thickness = average of all valid thickness values.',
    '- Min thickness = minimum value.',
    '- Max thickness = maximum value.',
    '- Standard deviation = variation across the map.',
    '- Remaining Wall % (RWT) = (t_measured − CA) / (t_nom − CA) × 100.',
    '- Thin cell = thickness < Tmin.',
    '- Zone criterion = cluster of ≥2 adjacent thin cells.',
    '- Cells < Tmin+CA = cells thinner than Tmin + CA, even if not below Tmin.',
    '- Percentages = (count / total valid cells) × 100.',
    '',
    'Report structure (Output ONLY):',
    '',
    '# Corrosion Map Stats',
    '',
    '## Report Summary',
    'One concise sentence on min/mean thickness, RWT, and thin zones.',
    '',
    '## Input Summary',
    '- Component ID: <id or Unknown>',
    '- Grid size: <rows × cols or Unknown>',
    '- Nominal thickness (t_nom): <value mm or Unknown>',
    '- Tmin: <value mm or Unknown>',
    '- Corrosion allowance (CA): <value mm or Unknown>',
    '- Measurement spacing: <value mm or Unknown>',
    '- Date/Time: <timestamp>',
    '- Operator/Equipment: <id values>',
    '- Media Input: <“C-scan image uploaded”, “B-scan cross-section uploaded”, “None”>',
    '',
    '## Key Outputs',
    '| Key outputs | Value |',
    '| --- | --- |',
    '| Min thickness (mm) | <value> |',
    '| Mean thickness (mm) | <value> |',
    '| Max thickness (mm) | <value> |',
    '| Std deviation (mm) | <value> |',
    '| Min RWT (%) | <value> |',
    '| Cells < Tmin | <count, %> |',
    '| Cells < Tmin+CA | <count, %> |',
    '| Flagged thin zones | <coordinate ranges or None> |',
    '',
    '## Calculations',
    '- Show formulas used (Mean, RWT, thresholds).',
    '- Show numeric substitution for min RWT explicitly.',
    '- Summarize cluster detection: list coordinates or ranges of flagged zones.',
    '- If image provided, state how it visually confirms or supports the flagged thin zones.',
    '',
    '## Rationale',
    'One concise sentence interpreting results ',
    '(e.g., "Local pitting zone detected at 1500–1600 mm axial, 90–120° circum; C-scan image confirms attenuated region. Overall wall integrity within limits.").',
    '',
    'END OF REPORT'
  ].join('\n')
};


